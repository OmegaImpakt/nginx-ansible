user www-data;

worker_processes auto;

events {
  worker_connections 1048576;
}

http {
  include mime.types;

  limit_req_zone $request_uri zone={{ zone }}  rate={{ rate }};

  gzip on;
  gzip_comp_level {{ gzip_comp_level }};
  gzip_types {{ gzip_types }};

  error_log {{ error_log }} {{ level }};

  server {
    listen {{ web_port }};
    server_name {{ server_name }};
    return 301 https://$host$request_uri;
  }

  server {
    listen 443 ssl http2;
    server_name {{ server_name }};
    root {{ project_directory }};
    index {{ index }};

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Proctection "1; mode=block";

    ssl_certificate {{ ssl_certificate }};
    ssl_certificate_key {{ ssl_certificate_key }};

    # Enorce TLS
    ssl_protocols TLSv1.3 TLSv1.2;

    ssl_prefer_server_ciphers on;
    ssl_ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
 
    # Enable DH params
    ssl_dhparam /etc/nginx/ssl/dhparam.pem;

    # Enforce not loading anything over http
    add_header Strict-Transport-Security "max-age=31536000" always;

    # Enabling SSL cache
    ssl_session_cache shared:SSL:40m;
    ssl_session_timeout 6h;
    ssl_session_tickets on; # Provide a ticket to validate a SSL session

    location / {
      limit_req zone=Omega-Zone burst=5;
      try_files $uri /friendly_404;
    }

    location /friendly_404 {
      try_files /my404.png =404;
    }
  }
}